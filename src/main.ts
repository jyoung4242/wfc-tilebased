import "./style.css";
import { UI } from "@peasy-lib/peasy-ui";
import { Assets } from "@peasy-lib/peasy-assets";
import { Input } from "@peasy-lib/peasy-input";

const wait = async (ms: number): Promise<void> => {
  return new Promise(res => setTimeout(res, ms));
};

const model = {
  cnv: undefined as HTMLCanvasElement | undefined,
  ctx: undefined as CanvasRenderingContext2D | null | undefined,
  entcnv: undefined as HTMLCanvasElement | undefined,
  entctx: undefined as CanvasRenderingContext2D | null | undefined,
};
const template = `<div> 
    <canvas \${==>cnv} width="160" height="160"></canvas>
    <canvas  \${==>entcnv} width="160" height="160"></canvas>
</div>`;
await UI.create(document.body, model, template).attached;
model.ctx = (model.cnv as HTMLCanvasElement).getContext("2d");
model.entctx = (model.entcnv as HTMLCanvasElement).getContext("2d");
Assets.initialize({ src: "src/assets/" });
await Assets.load(["tileset.png", "testwhite.png"]);

import { RuleType, TileObject, WFC } from "./wfc";

const numberOfTiles = 61 as number;
const rules: RuleType = [];
const mapwidth = 10;
const mapheight = 10;
const tilesize = 16;
const delay = 0;
//#region rules

/*
left group tiles = [2,11,20,5,14,23,8,17,26,29,38,47,32,41,50,35,44,53,55,56,65,57],
up group tiles = [18,19,20,21,22,23,24,25,26,45,46,47,48,49,50,51,52,53,63,55,57],
right group tiles = [0,9,48,3,12,21,6,15,24,27,36,45,30,39,48,33,42,51,54,55,63,57],
down group tiles=[0,1,2,3,4,5,6,7,8,27,28,29,30,31,32,33,34,54,55,63,65,57],

*/

rules[0] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [9],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [1],
};
rules[1] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [10],
  left: [0, 1],
  right: [1, 2],
};
rules[2] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [11],
  left: [1],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};
rules[3] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [12],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [4],
};
rules[4] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [13],
  left: [3, 4],
  right: [4, 5],
};
rules[5] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [14],
  left: [4],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};
rules[6] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [15],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [7],
};

rules[7] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [16],
  left: [6, 7],
  right: [7, 8],
};

rules[8] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [17],
  left: [7],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[9] = {
  up: [0, 9],
  down: [9, 18],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [10, 11],
};
rules[10] = {
  up: [1, 10],
  down: [19, 10],
  left: [9, 10],
  right: [11, 10],
};
rules[11] = {
  up: [11, 2],
  down: [20, 11],
  left: [10, 9],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[12] = {
  up: [3, 12],
  down: [12, 21],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [13],
};
rules[13] = {
  up: [13, 4],
  down: [13, 22],
  left: [13, 12],
  right: [13, 14],
};
rules[14] = {
  up: [14, 5],
  down: [23, 14],
  left: [13],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[15] = {
  up: [15, 6],
  down: [15, 24],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [16],
};
rules[16] = { up: [16, 7], down: [16, 25], left: [16, 15], right: [16, 17] };
rules[17] = {
  up: [17, 8],
  down: [26, 17],
  left: [16],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[18] = {
  up: [9],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 54, 55, 56,
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [19],
};
rules[19] = {
  up: [10],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 54, 55, 56,
  left: [18, 19],
  right: [19, 20],
};
rules[20] = {
  up: [11],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 54, 55, 56,
  left: [19],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[21] = {
  up: [12],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56,
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [22],
};
rules[22] = {
  up: [13],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [21, 22],
  right: [22, 23],
};
rules[23] = {
  up: [14],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 54, 55, 56,
  left: [22],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[24] = {
  up: [15],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [25],
};
rules[25] = {
  up: [16],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [24, 25],
  right: [25, 26],
};
rules[26] = {
  up: [17],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34,
  left: [25],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[27] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [36],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [28],
};
rules[28] = {
  up: [57], //, 18, 19, 20, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55, 65
  down: [37],
  left: [27, 28],
  right: [29, 28],
};
rules[29] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [38],
  left: [28],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[30] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [39],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [31],
};
rules[31] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [40, 49],
  left: [30, 31],
  right: [31, 32],
};
rules[32] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [41],
  left: [31],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[33] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [42],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [34],
};
rules[34] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [43],
  left: [33, 34],
  right: [34, 35],
};
rules[35] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 55,
  down: [44],
  left: [34],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[36] = {
  up: [36, 27],
  down: [36, 45],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [37],
};
rules[37] = {
  up: [37, 28],
  down: [37, 46],
  left: [37, 36],
  right: [37, 38],
};
rules[38] = {
  up: [38, 29],
  down: [47, 38],
  left: [37],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[39] = {
  up: [39, 30],
  down: [39, 48],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [40],
};
rules[40] = {
  up: [40, 31],
  down: [40, 49],
  left: [40, 39],
  right: [40, 41],
};
rules[41] = {
  up: [41, 32],
  down: [50, 41],
  left: [40],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[42] = {
  up: [42, 33],
  down: [42, 51],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [43],
};
rules[43] = {
  up: [43, 34],
  down: [43, 52],
  left: [43, 42],
  right: [43, 44],
};
rules[44] = {
  up: [44, 35],
  down: [44, 53],
  left: [42],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[45] = {
  up: [36],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [46],
};
rules[46] = {
  up: [37],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [46, 45],
  right: [46, 47],
};
rules[47] = {
  up: [38],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [46],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[48] = {
  up: [39],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [49],
};
rules[49] = {
  up: [40],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [49, 48],
  right: [49, 50],
};
rules[50] = {
  up: [41],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [49],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[51] = {
  up: [42],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65,
  right: [52],
};
rules[52] = {
  up: [43],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [52, 51],
  right: [52, 53],
};
rules[53] = {
  up: [44],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 57, 54, 55, 56
  left: [52],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63,
};

rules[54] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53,
  down: [63, 55, 64, 65],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53,
  right: [55, 56, 65],
};
rules[55] = {
  up: [54, 55, 56, 64, 57],
  down: [55, 63, 64, 65, 57],
  left: [54, 55, 63, 57],
  right: [55, 56, 65, 57],
};
rules[56] = {
  up: [57], //18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53,
  down: [55, 63, 64, 65],
  left: [54, 55, 63],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51,
};
rules[57] = {
  up: [18, 19, 20, 21, 22, 23, 24, 25, 26, 45, 46, 47, 48, 49, 50, 51, 52, 53, 63, 65, 55, 57],
  down: [0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34, 35, 54, 55, 56, 57],
  left: [2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53, 55, 56, 65, 57],
  right: [0, 9, 18, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51, 54, 55, 63, 57],
};

rules[63] = {
  up: [54, 55, 56, 64],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34,
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53,
  right: [55, 56, 65],
};
rules[64] = {
  up: [55],
  down: [55],
  left: [57], //2, 11, 20, 5, 14, 23, 8, 17, 26, 29, 38, 47, 32, 41, 50, 35, 44, 53
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51
};
rules[65] = {
  up: [54, 55, 56],
  down: [57], //0, 1, 2, 3, 4, 5, 6, 7, 8, 27, 28, 29, 30, 31, 32, 33, 34,
  left: [54, 55, 63, 64],
  right: [57], //0, 9, 48, 3, 12, 21, 6, 15, 24, 27, 36, 45, 30, 39, 48, 33, 42, 51
};

//rules[0] = { up: [], down: [], left: [], right: [] };
//#endregion rules

const wfc = new WFC(
  mapwidth,
  mapheight,
  numberOfTiles,
  rules,
  model.ctx as CanvasRenderingContext2D,
  model.entctx as CanvasRenderingContext2D,
  tilesize,
  Assets.image("tileset"),
  delay
);
await wfc.startWFC();
//console.log(wfc, model.ctx);
/* 
wfc.worldCells.forEach(async (cell: TileObject, index: number) => {
  const tileNumber = cell.id;
  const sTileX = tileNumber % 9;
  const sTileY = Math.floor(tileNumber / 9);
  const dTileX = index % wfc.mapwidth;
  const dTileY = Math.floor(index / wfc.mapwidth);

  if (model.ctx) model.ctx.drawImage(Assets.image("tileset"), sTileX * 16, sTileY * 16, 16, 16, dTileX * 16, dTileY * 16, 16, 16);
  console.log(`Drawing: tile: ${tileNumber} from location ${sTileX},${sTileY}, to ${dTileX}, ${dTileY} `);
}); */
